version: '3.8'

networks:
  monitoring:
    driver: bridge

services:
  prometheus:
    image: ${PROMETHEUS_IMAGE:-prom/prometheus:v3.5.0}
    container_name: prometheus
    networks:
      - monitoring
    volumes:
      - ./prometheus/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    environment:
      - PROMETHEUS_SCRAPE_INTERVAL=${PROMETHEUS_SCRAPE_INTERVAL:-2}
      - PROMETHEUS_EVALUATE_INTERVAL=${PROMETHEUS_EVALUATE_INTERVAL:-1}
      - PROMETHEUS_PORT=${PROMETHEUS_PORT:-9090}
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

    healthcheck:
      # use wget instead of curl
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/ready >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  grafana:
    image: ${GRAFANA_IMAGE:-grafana/grafana:12.0.2}
    container_name: grafana
    pull_policy: always
    user: "${UID:-1001}:${GID:-1001}"
    networks:
      - monitoring
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  cpu-pyjoules:
    image: aimilefth/cpu-pyjoules
    pull_policy: always
    container_name: cpu-pyjoules
    volumes:
      - /sys/class/powercap:/sys/class/powercap:ro
      - /sys/devices/virtual/powercap:/sys/devices/virtual/powercap:ro
    security_opt:
      - apparmor=docker-pyjoules
      - systempaths=unconfined
    networks:
      - monitoring
    environment:
      - REMOTE_WRITE_URL=${CLIENT_CPU_PYJOULES_URL:-http://prometheus:9090/api/v1/write}
      - SCRAPE_INTERVAL_S=${CLIENT_CPU_PYJOULES_SCRAPE_INTERVAL_S:-0.1}
      - PUSH_INTERVAL_S=${CLIENT_CPU_PYJOULES_PUSH_INTERVAL_S:-4}
      - MAX_RETRY_BATCHES=${CLIENT_CPU_PYJOULES_MAX_RETRY_BATCHES:-5}
      - SERVICE_LABEL=cpu-pyjoules
      - LOG_LEVEL=${CLIENT_CPU_PYJOULES_LOG_LEVEL:-INFO}

    # NEW â†“
    # the cpu-pyjoules image is based on python:3.11-slim,
    # which *does* have Python but not necessarily curl,
    # so we probe Prometheus using Python stdlib instead of curl.
    healthcheck:
      test:
        - CMD-SHELL
        - >
          python -c "import urllib.request,sys;
          urllib.request.urlopen('http://prometheus:9090/-/healthy', timeout=3);
          sys.exit(0)"
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
