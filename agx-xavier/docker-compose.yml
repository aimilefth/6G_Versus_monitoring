version: '3.3'

networks:
  monitoring:
    driver: bridge

services:
  agx-xavier:
    image: ${CLIENT_AGX_XAVIER_IMAGE:-aimilefth/6gversus-monitoring:agx-xavier}
    # Jetson AGX Xavier is ARM64:
    # pull_policy: always
    # container_name: agx-xavier
    networks:
      - monitoring
    # privileged: ${AGX_XAVIER_PRIVILEGED:-false}
    # sysfs access (read-only). These paths are used by the INA3221 driver.
    volumes:
      - /sys/bus/i2c/devices:/sys/bus/i2c/devices:ro
      - /sys/class/hwmon:/sys/class/hwmon:ro

    # # Docker masks some system paths; this can make sysfs files appear "missing".
    # security_opt:
    #   - systempaths=unconfined
    environment:
      - REMOTE_WRITE_URL=http://${CLIENT_AGX_PROMETHEUS_HOST:-host.docker.internal}:${CLIENT_AGX_PROMETHEUS_PORT:-9090}/api/v1/write
      - SCRAPE_INTERVAL_S=${CLIENT_AGX_SCRAPE_INTERVAL_S:-0.2}
      - PUSH_INTERVAL_S=${CLIENT_AGX_PUSH_INTERVAL_S:-4}
      - MAX_RETRY_BATCHES=${CLIENT_AGX_MAX_RETRY_BATCHES:-5}
      - LOG_LEVEL=${CLIENT_AGX_LOG_LEVEL:-INFO}
      - SERVICE_LABEL=${CLIENT_AGX_SERVICE_LABEL:-agx-xavier}

      # metric names (optional overrides)
      # - METRIC_POWER_W=agx_xavier_power_watts
      # - METRIC_VOLTAGE_V=agx_xavier_voltage_volts
      # - METRIC_CURRENT_A=agx_xavier_current_amps

    healthcheck:
      test:
        - CMD-SHELL
        - >
          python -c "import urllib.request,sys;
          urllib.request.urlopen('http://${CLIENT_AGX_PROMETHEUS_HOST:-host.docker.internal}:${CLIENT_AGX_PROMETHEUS_PORT:-9090}/-/healthy', timeout=3);
          sys.exit(0)"
      interval: 15s
      timeout: 5s
      retries: 3
      # start_period: 10s

    restart: unless-stopped
